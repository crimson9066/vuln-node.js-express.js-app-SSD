# semgrep-rules/injection.yaml
rules:
- id: custom-sequelize-sqli-final-match
  languages: [javascript]
  message: |
    FINAL CONFIRMED SQL Injection (V1). The variable passed to a raw query function 
    is assigned from unsanitized req.params. (OWASP A03: Injection)
  severity: ERROR
  metadata:
    cwe: 89
    impact: HIGH
    confidence: HIGH
  patterns:
    # 1. Match the Sink: db.sequelize.query()
  - pattern: |
      $DB.sequelize.query($SQL, ...);
    # 2. Check for the Taint Source: A request variable is used *somewhere* to define $SQL
  - pattern-inside: |
      $SQL = $TAINTED
    # 3. Define the Source: The $TAINTED variable must come from req.params.
  - pattern-either:
    - pattern-inside: |
        $TAINTED = req.params.$ANYTHING


- id: custom-path-traversal-req-params
  languages: [javascript]
  message: |
    Potential Path Traversal: User input from req.params is used to construct
    a file path. An attacker can use '..' to read or write files outside the
    intended directory. (OWASP A01: Broken Access Control)
  severity: ERROR
  metadata:
    cwe: 22
    impact: HIGH
    confidence: HIGH
  patterns:
    # 1. Look for path.join() or path.resolve()
  - pattern-either:
    - pattern: path.join(..., $TAINTED, ...)
    - pattern: path.resolve(..., $TAINTED, ...)
    # 2. Ensure the tainted variable is derived from the request
  - pattern-either:
    - pattern: req.params.$ANYTHING
    - pattern: req.query.$ANYTHING

- id: custom-reflected-xss-direct-send
  languages: [javascript]
  message: |
    Reflected XSS: Unsanitized user input from req.query is sent directly back
    to the client using res.send(), allowing an attacker to inject script tags.
    (OWASP A03: Injection)
  severity: WARNING
  metadata:
    cwe: 79
    impact: MEDIUM
    confidence: HIGH
  patterns:
    # 1. Match res.send() where the argument is user input
  - pattern: |
      res.send($INPUT)
    # 2. Ensure the input comes from the request (req) object
  - pattern-either:
    - pattern: req.query.$ANYTHING
    - pattern: req.params.$ANYTHING
    - pattern: req.body.$ANYTHING
    # 3. Exclude safe patterns
    - pattern-not: res.send($NUMBER)
    - pattern-not: res.send("...")